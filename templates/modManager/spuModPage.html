<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<link rel="stylesheet" type="text/css" href="../js/layui/css/layui.css"/>
		<link rel="stylesheet" type="text/css" href="../css/common.css"/>
		<link rel="stylesheet" type="text/css" href="../css/modManager.css"/>
		<link rel="stylesheet" type="text/css" href="../js/pace/pace-theme-flash.min.css"/>
		<script src="../js/pace/pace.min.js" type="text/javascript" charset="utf-8"></script>
		<title>lng燃气管理系统--模块管理</title>
	</head>
	<body>
		<div class="layui-fluid" style="margin-top:15px;">
			<div class="layui-row">
				<div class="layui-col-md12 layui-col-lg12">
					<div class="layui-card">
						<div class="layui-card-header posRel">
							<span>模块管理</span>
							<span id="outDateTips"></span>
							<a id="addMod" class="posAbs newAddBtn" opts="addBtn" href="javascript:void(0)"><i class="layui-icon layui-icon-add-circle"></i>添加主模块</a>
							<div class="roleList clearfix fr">
								<input id="roleIdInp" type="hidden" value="0"/>
								<div id="roleLists" class="fl layui-form"></div>
								<button class="layui-btn saveMod fl">保存</button>
							</div>
						</div>
						<div class="layui-card-body" pad15>
							<input type="hidden" id="madIdListInp"/>
							<div id="moduleList" class="moduleList">
								<!-- 
									allBindFlag : 全部都选中的时候
									mainBindFlag : 右侧全部选中的时候
									bindFlag - >selFlag
									orederNo
								 -->
								<ul id="modTit" class="noSelAll modListTit clearfix">
									<li class="orderNumWid">序号</li>
									<li class="mainModWid">主模块名</li>
									<li class="sonModWid">子模块名</li>
								</ul>
								<div id="listModCon" class="noSelAll">
									<ul class="spUl clearfix">
										<li class="orderNumWid hasPosAbso posL tongpaiColor flexBox">1</li>
										<li class="mainModWid hasAlign hasPosAbso posL1">
											<span class="modMainNameSpan flexBox"><b class="ellip">专利管理</b></span>
											<div class="setMainMod posAbs">
												<i class="layui-icon layui-icon-add-1 addSonModBtn" modid="1"></i>
												<i class="layui-icon layui-icon-edit editMainModName" opts="editBtn" modid="1"></i>
												<i class="layui-icon layui-icon-delete delMainModName" modid="1"></i>
											</div>
										</li>
										<li class="sonModWid sonModNames hasMargL">
											<p class="hasTxtAlign">
												<a href="javascript:void(0)" class="seSonMod posAbs  editSonModName" maid="2" actnamechi="浏览" actnameeng="listZl">
													<span>浏览(listZl)</span>
													<i class="layui-icon layui-icon-edit"></i>
												</a>
											</p>
											<p class="hasTxtAlign">
												<a href="javascript:void(0)" class="seSonMod posAbs  editSonModName" maid="2" actnamechi="浏览" actnameeng="listZl">
													<span>流程处理(listZl)</span>
													<i class="layui-icon layui-icon-edit"></i>
												</a>
											</p>
										</li>
										
									</ul>
									
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<script type="text/javascript" src="../js/jquery-1.7.2.min.js" charset="utf-8"></script>
		<script src="../js/layui/layui.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			var roleName = parent.roleName,loginType = parent.loginType,globalOpts = "addBtn",globalModId=0,madIdArray=[],roleList=[];
			layui.use(['layer','form'],function(){
				var layer = layui.layer,
					form = layui.form;
				var page = {
					data : {
						inpMainModName_cn : '',
						inpMainModUrl : '',
						inpMainModOrderNo : 0,
						mainModLevelInp : 0,
						mainModShowInp  : 0,
						globalIndex : 0,
						globalMainModId : [] //用于存放所有主模块Id
					},
					init : function(){
						$('#addMod').show();
						this.loadModuleList();
						this.bindEvent();
						this.bindEvent_multi();
					},
					loadModuleList : function(){
						var _this = this;
						$.ajax({
						    type:"get",
							data : { specUserId:'' },
						    dataType:"json",
						    url:"/mod/getModuleDetail",
						    success:function (json){
								console.log(json)
						    	layer.closeAll('loading');
								if(json.code == 200){
									var modList = json.datas;
									getModuleList(modList);
								}else if(json.code == 1000){
									layer.msg('服务器错误');
								}else if(json.code == 50001){
									layer.msg('暂无数据');
								}else if(json.code == 70001){
									layer.msg('暂无访问权限');
								}
						    }
						});
					},
					bindEvent : function(){
						var _this = this;
						//增加模块
						$('#addMod').on('click',function(){
							globalOpts = $(this).attr("opts");
							var addEditMainModCon = '';
							addEditMainModCon += '<div class="addEditMainModWrap layui-form">';
							addEditMainModCon += '<div class="comAddEditDiv"><span class="fl">主模块中文名字：</span><input id="inpMainModName_cn" type="text" placeholder="请输入模块中文名字(15字以内)" maxlength="15"></div>';
							addEditMainModCon += '<div class="comAddEditDiv"><span class="margLSpan_url fl">主模块动作Url：</span><input id="inpMainModUrl" type="text" placeholder="请输入模块动作url"></div>';
							
							addEditMainModCon += '</div>';
							_this.data.globalIndex = layer.open({
								title : '添加主模块',
								type: 1,
								skin:'layui-layer-molv', //样式类名
								closeBtn: 0, //不显示关闭按钮
								area : ['500px','200px'],
								content: addEditMainModCon,
								btn : ['确定','取消'],
								btnAlign:'c',
								yes: function(index, layero){
									_this.addEditMainModFun();
								},
								success : function(layero, index){
									form.render();
								}
							});
							
						});
					},
					bindEvent_multi : function(){
						var _this = this;
						//编辑主模块
						$('.editMainModName').on('click',function(){
							var modId = $(this).attr('modId');
							globalModId = modId;
							globalOpts = $(this).attr("opts");
							_this.data.globalIndex = layer.open({
								title : '编辑主模块',
								type: 2,
								skin:'layui-layer-molv', //样式类名
								closeBtn: 1, //不显示关闭按钮
								area : ['500px','330px'],
								btn : ['确定','取消'],
								btnAlign:'c',
								content: '/Module/modManager/jsp/editMainModName.html',
								yes : function(index, layero){
									var body = layer.getChildFrame('body', index);
									if(body.find('#isHasData').val() == 1){//表示有数据
										_this.data.inpMainModName_cn = body.find('#inpMainModName_cn').val();
										//_this.data.inpMainModName_eng = body.find('#inpMainModName_eng').val();
										_this.data.inpMainModUrl = body.find('#inpMainModUrl').val();
										_this.data.inpMainModOrderNo = body.find('#inpMainModOrderNo').val();
										_this.data.mainModLevelInp = body.find('#mainModLevelInp').val();
										_this.data.mainModShowInp = body.find('#mainModShowInp').val();
										_this.addEditMainModFun(modId);
									}else{
										layer.close(index);
									}
								}
							});
							
						});
					},
					//添加、编辑主模块方法
					addEditMainModFun : function(modId){
						var _this = this,
							inpMainModName_cn = globalOpts == 'addBtn' ? $.trim($('#inpMainModName_cn').val()) : _this.data.inpMainModName_cn,
							inpMainModUrl = globalOpts == 'addBtn' ? $.trim($('#inpMainModUrl').val()) : _this.data.inpMainModUrl,
							regCN = /^[\u4E00-\u9FA5]+$/,
							regNum = /^[1-9]\d*$/;
						if(inpMainModName_cn == ''){
							layer.msg('模块中文名字不能为空', {icon:5,anim:6,time:1000});
						}else if(inpMainModUrl == ''){
							layer.msg('模块动作Url不能为空', {icon:5,anim:6,time:1000});
						}else{
							if(!regCN.test(inpMainModName_cn)){
								layer.msg('模块中文名字应为汉字', {icon:5,anim:6,time:1000});
							}else if(regCN.test(inpMainModUrl)){
								layer.msg('模块动作Url不能含有汉字', {icon:5,anim:6,time:1000});
							}else{
								//执行ajax
								var url = '';
								if(globalOpts == 'addBtn'){//表示增加主模块
									url = '/mod/addMod';
									var field = {modName:escape(inpMainModName_cn),modUrl:inpMainModUrl};
								}else if(globalOpts == 'editBtn'){//表示编辑主模块
									url = '/mod/upMod';
									var field = {modId:modId,modName:escape(inpMainModName_cn),modUrl:inpMainModUrl};
								}
								layer.load();
								$.ajax({
									type:"post",
									dataType:"json",
									data :field,
									url:url,
									success:function (json){
										layer.closeAll("loading");
										if(json["code"] == 200){
											var strTxt = '';
											if(globalOpts == "addBtn"){//表示增加主模块
												strTxt = '添加成功';
											}else if(globalOpts == "editBtn"){//表示编辑主模块
												strTxt = '编辑成功';
											}
											function callBackSuccess(){
												layer.msg(strTxt,{icon:1,time:1200},function(){
													_this.loadModuleList();
													//_this.bindEvent_multi();
													layer.close(_this.data.globalIndex);
													_this.data.globalIndex = 0;
												});
											}
											callBackSuccess(strTxt);
										}else if(json["code"] == 1000){//模块名字已存在
											layer.msg("服务器错误", {icon:5,anim:6,time:1200});
										}else if(json["code"] == 50003){//系统错误
											layer.msg("当前添加主模块已存在", {icon:5,anim:6,time:1200});
										}else if(json["code"] == 70001){
											layer.msg("抱歉，您暂无权限增加模块", {icon:5,anim:6,time:1200});
										}
									}
								});
							}
						}
					}
				};
				page.init();
				function getModuleList(modList){
					var strHtml = '';
					strHtml += '<ul id="modTit" class="noSelAll modListTit clearfix">';
					strHtml += '<li class="orderNumWid">序号</li>';
					strHtml += '<li class="mainModWid">主模块名</li><li class="sonModWid">子模块名</li></ul>';
					strHtml += '<div id="listModCon" class="noSelAll">';
					for(var i=0;i<modList.length;i++){
						page.data.globalMainModId.push(modList[i].modId);
						strHtml += '<ul class="spUl clearfix">';
						strHtml += '<li class="orderNumWid hasPosAbso posL flexBox">'+ modList[i].modOrder +'</li>';
						
						//主模块名字
						strHtml += '<li class="mainModWid hasAlign hasPosAbso posL1"><span class="modMainNameSpan flexBox"><b class="ellip">'+ modList[i].modName +'</b></span>';
						strHtml += '<div class="setMainMod posAbs"><i class="layui-icon layui-icon-add-1 addSonModBtn" modId="'+ modList[i].modId +'"></i><i class="layui-icon layui-icon-edit editMainModName" opts="editBtn" modId="'+ modList[i].modId +'"></i>';
						strHtml += '</div>';
						strHtml += '</li>';
						//子模块名
						strHtml += '<li class="sonModWid sonModNames hasMargL">';
						if(modList[i].modSubList.length > 0){
							for(var j=0;j<modList[i].modSubList.length;j++){
								strHtml += '<p class="hasTxtAlign">';
								strHtml += '<a href="javascript:void(0)" class="seSonMod editSonModName" maId="'+ modList[i].modSubList[j].maId +'" actNameChi="'+ modList[i].modSubList[j].actNameChi +'" actNameEng="'+ modList[i].modSubList[j].actNameEng +'">';
								strHtml += '<span>'+ modList[i].modSubList[j].maChi +'('+modList[i].modSubList[j].maEng +')</span>';
								strHtml += '<i class="layui-icon layui-icon-edit"></i></a>';
								strHtml += '</p>';
							}
						}
						strHtml += '</li></ul>';
					}
					strHtml += '</div>';
					$('#moduleList').html(strHtml);
					form.render();
				}
				
			});
		</script>
	</body>
</html>
