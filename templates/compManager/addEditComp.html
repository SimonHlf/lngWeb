<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<link rel="stylesheet" type="text/css" href="../js/layui/css/layui.css"/>
		<link rel="stylesheet" type="text/css" href="../css/compManager.css"/>
		<title>添加编辑公司</title>
	</head>
	<body>
		<div class="addEditWrap layui-form layui-clear">
			<div class="layui-form-item addEditItem">
				<label class="layui-form-label"><span class="mustItem">*</span>公司名称</label>
				<div class="layui-input-block">
					<input id="compNameInp" type="text" placeholder="请输入公司名称(35字以内)" maxlength="35" autocomplete="off" class="layui-input"/>
				</div>		
			</div>
			<div class="layui-form-item addEditItem">
				<label class="layui-form-label"><span class="mustItem">*</span>公司类型</label>
				<div id="compTypeWrap" class="layui-input-block">
					<input type="hidden" id="compTypeInp" />
					<select id="compTypeSel" lay-filter="compTypeSel">
						<option value="">请选择公司类型</option>
					</select>
				</div>		
			</div>
			<div class="layui-form-item addEditItem">
				<label class="layui-form-label">公司联系人</label>
				<div class="layui-input-block">
					<input id="lxrNameInp" type="text" placeholder="请输入公司联系人(6字以内)" maxlength="6" autocomplete="off" class="layui-input"/>
				</div>		
			</div>
			<div class="layui-form-item addEditItem">
				<label class="layui-form-label">手机号码</label>
				<div class="layui-input-block">
					<input id="phoneNumInp" type="text" placeholder="请输入手机号码" maxlength="11" autocomplete="off" class="layui-input"/>
				</div>		
			</div>
			<div class="layui-form-item addEditItem">
				<label class="layui-form-label">公司银行名称</label>
				<div class="layui-input-block">
					<input id="bankName" type="text" placeholder="请输入公司银行名称" maxlength="30" autocomplete="off" class="layui-input"/>
				</div>		
			</div>
			<div class="layui-form-item addEditItem">
				<label class="layui-form-label">公司开户行</label>
				<div class="layui-input-block">
					<input id="bankAccName" type="text" placeholder="请输入公司开户行" maxlength="40" autocomplete="off" class="layui-input"/>
				</div>		
			</div>
			<div class="layui-form-item addEditItem">
				<label class="layui-form-label">公司银行卡号</label>
				<div class="layui-input-block">
					<input id="bankNo" type="text" placeholder="请输入公司银行卡号" maxlength="19" autocomplete="off" class="layui-input"/>
				</div>		
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">选择地区</label>
				<input type="hidden" id="provInp" />
				<div class="itemDet">
					<select name="province" lay-filter="province">
						<option value="">请选择省</option>
					</select>
				</div>
				<div class="itemDet">
					<input type="hidden" id="cityInp" />
					<select name="city" lay-filter="city" disabled>
						<option value="">请选择市</option>
					</select>
				</div>
				<div class="itemDet">
					<input type="hidden" id="countyInp" />
					<select name="area" lay-filter="area" disabled>
						<option value="">请选择县/区</option>
					</select>
				</div>
			</div>
			<div class="layui-form-item addEditItem">
				<label class="layui-form-label">公司地址</label>
				<div class="layui-input-block">
					<input id="compAddInp" type="text" placeholder="请输入公司地址" maxlength="50" autocomplete="off" class="layui-input"/>
				</div>		
			</div>
			<div class="layui-form-item addEditItem">
				<label class="layui-form-label"></label>
				<div class="layui-input-block" style="width:75%;text-align:center;">
					<button type="button" id="saveCompInfoBtn" class="layui-btn" style="width:150px;margin-left:0px;">保存公司信息</button>
				</div>
			</div>
			
		</div>
		
		<script type="text/javascript" src="../js/jquery-1.8.3.min.js" charset="utf-8"></script>
		<script src="../js/layui/layui.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			var globalOpts = parent.globalOpts;
			layui.config({
				base: '../js/frame/js/'
			}).extend({ //设定组件别名
			    common:  'address'// 表示模块文件的名字
			}).use(['form','layer','address'],function(){
				var form = layui.form,layer=layui.layer,address = layui.address();
				form.on('select(compTypeSel)',function(data){
					data.value == '' ? $('#compTypeInp').val('') : $('#compTypeInp').val(data.value);
				});
				var page = {
					init : function(){
						this.loadCompType();
						this.bindEvent();
						if(globalOpts == 'editBtn'){
							this.loadCompInfo();
						}
					},
					loadCompType : function(){
						var _this = this;
						layer.load('1');
						$.ajax({
						    type:"get",
							data : { id:'' },
						    dataType:"json",
						    url:"/comType/queryComType",
						    success:function (json){
						    	layer.closeAll('loading');
								if(json.code == 200){
									console.log(json)
									_this.renderCompTypeHtml(json.datas);
								}else if(json.code == 1000){
									layer.msg('服务器错误');
								}else if(json.code == 50001){
									$('#compTypeSel').remove();
									$('#compTypeWrap').append('<p style="color:#999;">暂无公司类型，请先添加</p>');
								}
						    }
						});
					},
					renderCompTypeHtml : function(list){
						if(list.length > 0){
							var strHtml = '';
							strHtml += '<option value="">请选择公司类型</option>';
							for(var i=0;i<list.length;i++){
								strHtml += '<option value="'+ list[i].id +'">'+ list[i].name +'</option>';
							}
							$('#compTypeSel').html(strHtml);
							form.render();
						}else{
							$('#compTypeSel').next().remove();
							$('#compTypeSel').remove();
							$('#compTypeWrap').append('<p style="color:#999;">暂无公司类型，请先添加</p>');
						}
					},
					bindEvent : function(){
						var _this = this;
						$('#saveCompInfoBtn').on('click',function(){
							var compNameInp = $('#compNameInp').val(),
								compTypeInp = $('#compTypeInp').val(),
								lxrNameInp = $('#lxrNameInp').val(),
								phoneNumInp = $('#phoneNumInp').val(),
								bankName =  $('#bankName').val(),
								bankAccName = $('#bankAccName').val(),
								bankNo = $('#bankNo').val(),
								provInp = $('#provInp').val(),
								cityInp = $('#cityInp').val(),
								countyInp = $('#countyInp').val(),
								compAddInp = $('#compAddInp').val(),
								regPhone = /^1\d{10}$/;
							var index= parent.layer.getFrameIndex(window.name);
							if(compNameInp == ''){
								layer.msg('请填写公司名称');
							}else if(compTypeInp == ''){
								layer.msg('请选择公司类型');
							}else if(phoneNumInp != '' && !regPhone.test(phoneNumInp) && phoneNumInp.length != 11){
								layer.msg('手机号码格式不对，请重新填写');
							}else{
								layer.load('1');
								var field = {name:compNameInp,typeId:compTypeInp,owerUserId:'',lxname:lxrNameInp,lxtel:phoneNumInp,bankName:bankName,bankAcc:bankAccName,bankNo:bankNo,province:provInp,city:cityInp,county:countyInp,address:compAddInp};
								$.ajax({
								    type:"POST",
									data : field,
								    dataType:"json",
								    url:"/company/addCompany",
								    success:function (json){
								    	layer.closeAll('loading');
										if(json.code == 200){
											var title = globalOpts == 'addBtn' ?　'添加公司成功' : '编辑公司成功';
											layer.msg(title,{icon:1,time:1000},function(){
												parent.addEditFlag = true;
												parent.layer.close(index);
											});
										}else if(json.code == 1000){
											layer.msg('服务器错误');
										}else if(json.code == 50003){
											layer.msg('当前公司已存在，不能重复添加');
										}else if(json.code == 50003){
											layer.msg('抱歉，您暂无权限添加编辑公司');
										}
								    }
								});
							}
						});
					}
				};
				page.init();
			});
		</script>
	</body>
</html>
