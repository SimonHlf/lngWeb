<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<link rel="stylesheet" type="text/css" href="../js/layui/css/layui.css"/>
		<link rel="stylesheet" type="text/css" href="../css/addEditTruckTrade.css"/>
		<title>添加/编辑槽车租卖</title>
	</head> 
	<body>
		<div class="truckTradeWrap layui-form">
			<div class="layui-form-item addEditItem">
				<input type="hidden" id="tradeTypeInp"/>
				<label class="layui-form-label"><span class="mustItem">*</span>贸易类型</label>
				<div class="layui-input-block">
					<input type="radio" value="0" name="tradeTypeName" title="可租可卖" lay-filter="tradeTypeFilter"/>
					<input type="radio" value="1" name="tradeTypeName" title="租" lay-filter="tradeTypeFilter"/>
					<input type="radio" value="2" name="tradeTypeName" title="卖" lay-filter="tradeTypeFilter"/>
				</div>		
			</div>
			<div class="layui-form-item addEditItem">
				<input type="hidden" id="compNameInp"/>
				<label class="layui-form-label"><span class="mustItem">*</span>公司名称</label>
				<div class="layui-input-block comInpItem">
					<select id="compNameSel" lay-filter="compNameSel">
						<option value="">请选择公司</option>
					</select>
				</div>
			</div>
			
			<div class="layui-form-item">
				<label class="layui-form-label"><span class="mustItem">*</span>储罐主图</label>
				<div class="layui-input-block">
					<a id="addImgBtn_main" title="添加储罐主图" class="addMainImgBtn" href="javascript:void(0)">
						<i class="iconfont icon-add"></i>
						<img id="thubImg_main"/>
					</a>
					<p class="tipsInfo">
						<i class="iconfont icon-gonggao"></i>
						<span>请上传储罐主图，建议图片宽高尺寸750*400</span>
					</p>
					<span class="viewMainBigImg">查看原图</span>
				</div>		
			</div>

			<!-- 危货下储罐品牌 容积以及上牌年月 -->
			<div class="dangerItemWrap" style="display: block;">
				<div class="layui-form-item">
					<label class="layui-form-label"><span class="mustItem">*</span>储罐品牌</label>
					<input type="hidden" id="tankBandInp"/>
					<div class="layui-input-block comInpItem">
						<select id="tankBandSel" lay-filter="tankBandSel">
							<option value="">请选择储罐品牌</option>
						</select>
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label"><span class="mustItem">*</span>储罐容积</label>
					<div class="layui-input-block comInpItem">
						<input id="volumeInp" type="text" placeholder="请输入储罐容积(1-1000立方)" class="layui-input" autocomplete="off" maxlength="5"/>
						<span class="danweiTxt">m³</span>
					</div>
				</div>
				
				<div class="layui-form-item addEditItem">
					<input type="hidden" id="sxInfoInp"/>
					<label class="layui-form-label"><span class="mustItem">*</span>有无手续</label>
					<div class="layui-input-block">
						<input type="radio" value="1" name="sxInfoName" title="有" lay-filter="sxInfoFilter"/>
						<input type="radio" value="2" name="sxInfoName" title="无" lay-filter="sxInfoFilter"/>
					</div>		
				</div>
				
				
				<div class="layui-form-item addEditItem">
					<label class="layui-form-label"><span class="mustItem">*</span>购置年份</label>
					<div class="layui-input-block comInpItem">
						<input id="potBuyTime" type="text" placeholder="请选择储罐购置年份" readonly class="layui-input"/>
						<span class="danweiTxt">年</span>
					</div>		
				</div>

			</div>
			
			
			<div class="layui-form-item addEditItem">
				<input type="hidden" id="zzjzInp"/>
				<label class="layui-form-label"><span class="mustItem">*</span>装载介质</label>
				<div class="layui-input-block comInpItem">
					<select id="zzjzSel" lay-filter="zzjzSel">
						<option value="">请选择装载介质</option>
					</select>
				</div>
			</div>
			<div class="layui-form-item addEditItem">
				<label class="layui-form-label"><span class="mustItem">*</span>罐所在选择地区</label>
				<input type="hidden" id="provInp" />
				<input type="hidden" id="cityInp" />
				<div class="itemDet provItemDet">
					<select id="provinceSel" name="province" lay-filter="province">
						<option value="">请选择省</option>
					</select>
				</div>
				<div class="itemDet">
					<select id="citySel" name="city" lay-filter="city" disabled>
						<option value="">请选择市区</option>
					</select>
				</div>
			</div>
			
			<div class="layui-form-item addEditItem" id="zulinPriceWrap">
				<label class="layui-form-label"><span class="mustItem">*</span>租卖价格</label>
				<div class="layui-input-block comInpItem">
					<input id="zlPriceInp" type="text" class="layui-input" placeholder="请输入租卖价格" autocomplete="off" maxlength="10"/>
					<span class="danweiTxt">元</span>
				</div>		
			</div>
			<div class="layui-form-item addEditItem" id="xsPriceWrap">
				<label class="layui-form-label"><span class="mustItem">*</span>销售价格</label>
				<div class="layui-input-block comInpItem">
					<input id="xsPriceInp" type="text" class="layui-input" placeholder="请输入销售价格" autocomplete="off" maxlength="10"/>
					<span class="danweiTxt">元</span>
				</div>		
			</div>
			
			<div class="layui-form-item addEditItem">
				<label class="layui-form-label"><span class="mustItem">*</span>联系人</label>
				<div class="layui-input-block comInpItem">
					<input id="lxrNameInp" type="text" class="layui-input" placeholder="请输入联系人姓名" autocomplete="off" maxlength="10"/>
				</div>		
			</div>
			<div class="layui-form-item addEditItem">
				<label class="layui-form-label"><span class="mustItem">*</span>手机号码</label>
				<div class="layui-input-block comInpItem">
					<input id="lxrTel" type="text" class="layui-input" placeholder="请输入联系人手机号码" autocomplete="off" maxlength="11"/>
				</div>		
			</div>
			
			<div class="layui-form-item addEditItem">
				<label class="layui-form-label">产品描述</label>
				<div class="layui-input-block comInpItem">
					<textarea id="remark" placeholder="请输入产品描述 (200字以内)" maxlength="200" class="layui-textarea"></textarea>
				</div>		
			</div>
			
			<div class="layui-form-item addEditItem">
				<label class="layui-form-label">储罐详情图</label>
				<span class="tipsTxt">最多上传9张</span>
				<div class="layui-input-block comInpItem">
					<div class="detImgList">
						<ul id="detImgListUl"></ul>
					</div>
					<a id="addDetImgBtn" title="添加图片" class="addDetImgBtn" href="javascript:void(0)">
						<i class="iconfont icon-add"></i>
					</a>
				</div>
			</div>
			
			
			<div class="layui-form-item comInpItem hasAlign">
				<button id="saveBtn" class="layui-btn">保存储罐租卖信息</button>
			</div>
		</div>
		
		<script type="text/javascript" src="../js/jquery-1.8.3.min.js" charset="utf-8"></script>
		<script src="../js/layui/layui.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			var mainImgSucc = '',tmpDetImgArr = [];
			var ptId = parent.ptId;
			var globalOpts = parent.globalOpts,isRightZulinPrice = false,isRightVolume = false,isRightXsPrice = false,currPage = 'addEditPotTradePage';
			layui.config({
				base: '/js/frame/js/'
			}).use(['layer','form','address','upload','basicInfo','laydate','uploadImg'],function(){
				var layer = layui.layer,form = layui.form,laydate=layui.laydate,upload = layui.upload,basicInfo=layui.basicInfo,uploadImg = layui.uploadImg;
				laydate.render({'elem':'#potBuyTime',trigger: 'click',type:'year'});
				//贸易类型
				form.on('radio(tradeTypeFilter)',function(data){
					$('#tradeTypeInp').val(data.value);
					if(data.value == 0){
						$('#zulinPriceWrap').show();
						$('#xsPriceWrap').show();
					}else if(data.value == 1){//租
						$('#zulinPriceWrap').show();
						$('#xsPriceWrap').hide();
					}else{//卖
						$('#zulinPriceWrap').show();
						$('#xsPriceWrap').hide();
					}
					$('#zlPriceInp').val('');
					$('#xsPriceInp').val('');
					isRightZulinPrice = false;
					isRightXsPrice = false;
					form.render();
				})
				//有无手续
				form.on('radio(sxInfoFilter)',function(data){
					$('#sxInfoInp').val(data.value);
				})
				var page = {
					init : function(){
						uploadImg.uploadMultiImg('addDetImgBtn','detImgListUl',9);
						basicInfo.getTankBrand();
						basicInfo.getZzjz();
						this.uploadMainImg();
						basicInfo.getCompanyList();
						this.bindEvent();
						if(globalOpts == 'editBtn'){
							var _this = this;
							setTimeout(function(){
								_this.loadPotTradeInfo();
							},200);
						}else{
							layui.address();
						}
					},
					loadPotTradeInfo : function(){
						var field = {id:ptId},_this = this;
						$.ajax({
						    type:"get",
							data : field,
						    dataType:"json",
						    url:"/potTrade/getPotTradeById",
						    success:function (json){
						    	layer.closeAll('loading');
								if(json.code == 200){
									_this.renderPotTradeInfo(json.datas[0]);
								}else if(json.code == 1000){
									layer.msg('服务器错误');
								}else if(json.code == 10002){
									layer.msg('请求参数为空');
								}else if(json.code == 50001){
									layer.msg('当前槽车租卖信息不存在');
								}
						    }
						});
					},
					renderPotTradeInfo : function(list){
						isRightZulinPrice = true;
						isRightVolume = true;
						$('#tradeTypeInp').val(list.tradeStatus);
						$('input[name=tradeTypeName]').each(function(i){
							if($('input[name=tradeTypeName]').eq(i).val() == list.tradeStatus){
								$('input[name=tradeTypeName]').eq(i).attr('checked',true);
							}
						});
						$('#zulinPriceWrap').show();
						$('#zlPriceInp').val(list.leasePrice);
						if(list.tradeStatus == 0 ){//可租可卖
							isRightXsPrice = true
							$('#xsPriceWrap').show();
							$('#zlPriceInp').val(list.sellPrice);
						}
						$('#compNameInp').val(list.cpyId);
						$('#compNameSel option').each(function(i){
							if($('#compNameSel option').eq(i).val() == list.cpyId){
								$('#compNameSel option').eq(i).attr('selected','selected');
							}
						});
						mainImgSucc = list.mainImg.replace('_small','');
						$('#thubImg_main').show().attr('src','../' + list.mainImg);
						$('.viewMainBigImg').show();
						$('#tankBandInp').val(list.potPpId);
						
						$('#tankBandSel option').each(function(i){
							if($('#tankBandSel option').eq(i).val() == list.potPpId){
								$('#tankBandSel option').eq(i).attr('selected','selected');
							}
						});
						$('#volumeInp').val(list.potVolume);
						$('#sxInfoInp').val(list.sxInfo);
						$('input[name=sxInfoName]').each(function(i){
							if($('input[name=sxInfoName]').eq(i).val() == list.sxInfo){
								$('input[name=sxInfoName]').eq(i).attr('checked',true);
							}
						});
						$('#potBuyTime').val(list.buyYear);
						$('#zzjzInp').val(list.zzjzTypeId);
						$('#zzjzSel option').each(function(i){
							if($('#zzjzSel option').eq(i).val() == list.zzjzTypeId){
								$('#zzjzSel option').eq(i).attr('selected','selected');
							}
						});
						
						$('#provInp').val(list.province);
						$('#cityInp').val(list.city);
						provVal = list.province;
						cityVal = list.city;
						$('#lxrNameInp').val(list.lxName);
						$('#lxrTel').val(list.lxTel);
						$('#remark').val(list.reMark);
						
						if(list.detailImg.length > 0){
							var str = '';
							hasUpNum = list.detailImg.length;
							var tmpDetBigImg = [];
							if(list.detailImg.length == 9){
								$('#addDetImgBtn').hide();
							}
							for(var i=0;i<list.detailImg.length;i++){
								tmpDetBigImg.push( list.detailImg[i].pdiImg.replace('_small','') );
								str += '<li><input type="hidden" name="detImgInp" value="'+ tmpDetBigImg[i] +'"/><a href="javascript:void(0)" onclick="deleteImg(this)" title="删除"><i class="layui-icon layui-icon-delete"></i></a><img src="../' + list.detailImg[i].pdiImg + '"/><span onclick=viewBigImg(\''+ tmpDetBigImg[i] +'\')>查看原图</span></li>';
							}
							$('#detImgListUl').html(str);
							
						}
						form.render();
						layui.address();
					},
					uploadMainImg : function(){
						upload.render({
						    elem: '#addImgBtn_main'
						    ,url: '/upload/uploadSingle'
							,method : 'post'
						    ,accept : 'images'
							,auto: true
							,before: function(obj){
								layer.load();
						    }
						    ,done: function(res){
								layer.closeAll('loading');
							    $('#thubImg_main').show().attr('src','/tempImg/' + res.datas);
							    $('.viewMainBigImg').show();
							    mainImgSucc = res.datas;
						    }
						});
					},
					bindEvent : function(){
						$('.viewMainBigImg').on('click',function(){
							if(globalOpts == 'addBtn'){
								window.open('/tempImg/' + mainImgSucc);
							}else{
								window.open('../' + mainImgSucc);
							};
						});
						$('#volumeInp').on('blur',function(){
							var regNum = /^\+?[1-9]\d*$/;
							if($(this).val() != ''){
								if(!regNum.test( $.trim($(this).val()) )){
									layer.msg('储罐容积是大于0的正整数');
									isRightVolume = false;
								}else{
									isRightVolume = true;
								}
							}else{
								isRightVolume = false;
							}
						});
						$('#zlPriceInp').on('blur',function(){
							var regNum = /^\+?[1-9]\d*$/;
							if($(this).val() != ''){
								if(!regNum.test( $.trim($(this).val()) )){
									layer.msg('租卖价格应是大于0的正整数');
									isRightZulinPrice = false;
								}else{
									isRightZulinPrice = true;
								}
							}else{
								isRightZulinPrice = false;
							}
						});
						$('#xsPriceInp').on('blur',function(){
							var regNum = /^\+?[1-9]\d*$/;
							if($(this).val() != ''){
								if(!regNum.test( $.trim($(this).val()) )){
									layer.msg('销售价格应是大于0的正整数');
									isRightXsPrice = false;
								}else{
									isRightXsPrice = true;
								}
							}else{
								isRightXsPrice = false;
							}
						});
						$('#saveBtn').on('click',function(){
							var tradeTypeInp = $('#tradeTypeInp').val(),
								compNameInp = $('#compNameInp').val(),
								tankBandInp = $('#tankBandInp').val(),
								volumeInp = $.trim($('#volumeInp').val()),
								sxInfoInp = $('#sxInfoInp').val(),
								potBuyTime = $('#potBuyTime').val(),
								zzjzInp = $('#zzjzInp').val(),
								provInp = $('#provInp').val(),
								cityInp = $('#cityInp').val(),
								
								zlPriceInp = $('#zlPriceInp').val(),
								xsPriceInp = $('#xsPriceInp').val(),
								lxrNameInp = $.trim($('#lxrNameInp').val()),
								lxrTel = $.trim($('#lxrTel').val()),
								remark = $.trim($('#remark').val()),
								regPhone = /^1\d{10}$/,imgDetStr='',detImgInpLen = $('input[name=detImgInp]').length;
							
							if(tradeTypeInp == ''){
								layer.msg('请选择租卖类型');
							}else if(compNameInp == ''){
								layer.msg('请选择公司');
							}else if(mainImgSucc == ''){
								layer.msg('请上传储罐主图');
							}else if(tankBandInp == ''){
								layer.msg('请选择储罐品牌');
							}else if(volumeInp == ''){
								layer.msg('请输入储罐容积');
							}else if(isRightVolume == false){
								layer.msg('储罐容积是大于0的正整数');
							}else if(sxInfoInp == ''){
								layer.msg('请选择有无手续');
							}else if(potBuyTime == ''){
								layer.msg('请选择储罐购买年份');
							}else if(zzjzInp == ''){
								layer.msg('请选择装载介质');
							}else if(provInp == ''){
								layer.msg('请选择罐所在省');
							}else if(cityInp == ''){
								layer.msg('请选择罐所在市');
							}else if(tradeTypeInp == 0 && zlPriceInp == '' && xsPriceInp == ''){
								layer.msg('请输入租卖价格和销售价格');
							}else if(tradeTypeInp == 1 && zlPriceInp == ''){
								layer.msg('请输入租卖价格');
							}else if(isRightZulinPrice == false){
								layer.msg('租卖价格应是大于0的正整数');
							}else if(tradeTypeInp == 0 && isRightXsPrice == false){
								layer.msg('销售价格应是大于0的正整数');
							}else if(lxrNameInp == ''){
								layer.msg('请输入联系人姓名');
							}else if(lxrTel == ''){
								layer.msg('请输入联系人手机号码');
							}else if(!regPhone.test(lxrTel) && lxrTel.length != 11){
								layer.msg('手机号码格式不对，请重新填写');
							}else{
								var url = '',type = '';
								var index= parent.layer.getFrameIndex(window.name);
								tmpDetImgArr.length = 0;
								if(detImgInpLen > 0){
									$('input[name=detImgInp]').each(function(i){
										tmpDetImgArr.push($('input[name=detImgInp]').eq(i).val());
									});
									imgDetStr = tmpDetImgArr.join(',');
								}
								var field = {compId:compNameInp,mainImg:mainImgSucc,potPpId:tankBandInp,potVol:volumeInp,sxInfo:sxInfoInp,
									buyYear:potBuyTime,zzjzTypeId:zzjzInp,province:provInp,city:cityInp,leasePrice:zlPriceInp,sellPrice:xsPriceInp,
									tradeStatus:tradeTypeInp,lxName:lxrNameInp,lxTel:lxrTel,remark:remark,potDetailImg:imgDetStr};
								if(globalOpts == 'addBtn'){
									url = '/potTrade/addPotTrade';
									type = 'post';
								}else if(globalOpts == 'editBtn'){
									var editField ={id:ptId};
									field = Object.assign(field,editField);
									url = '/potTrade/updatePotTrade';
									type = 'put';
								}
								//console.log(JSON.stringify( field ))
								layer.load('1');
								$.ajax({
								    type:type,
									data : field,
								    dataType:"json",
								    url:url,
								    success:function (json){
								    	layer.closeAll('loading');
										if(json.code == 200){
											var title = globalOpts == 'addBtn' ? '添加储罐租卖信息成功' : '编辑储罐租卖信息成功';
											layer.msg(title,{icon:1,time:1200},function(){
												parent.addEditFlag = true;
												parent.ptId = '';
												parent.layer.close(index);
											});
										}else if(json.code == 1000){
											layer.msg('服务器错误');
										}else if(json.code == 50001){
											layer.msg('当前储罐租卖信息不存在');
										}else if(json.code == 70001){
											layer.msg('抱歉，您暂无对储罐租卖添加或编辑的权限');
										}else if(json.code == 80001){
											layer.msg('当前储罐租卖信息审核已通过，暂不能修改');
										}
								    }
								});
							}	
						});
					}
				};
				page.init();
			});
		</script>
	</body>
</html>
